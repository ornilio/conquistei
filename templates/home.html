{% extends "base.html" %}

{% block title %}
  🏁 Base de Comando
{% endblock %}

{% block head %}
  <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base_comando.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="home-container" style="text-align: center;">
  <h2>🎮 Comandante: {{ current_user.username }}</h2>

  <div class="status-geral">
    <div class="status-card"><span>🏆</span><h4>Áreas Dominadas</h4><p>{{ conquistas | length }}</p></div>
    <div class="status-card"><span>📏</span><h4>Distância Total</h4><p>{{ distancia_total }} km</p></div>
    <div class="status-card"><span>⏱️</span><h4>Tempo Total</h4><p>{{ tempo_total }} min</p></div>
  </div>

  {% if conquistas|length > 0 %}
  <div class="carrossel-setores" style="justify-content: center;">
    {% for c in conquistas %}
    <div class="card-area" onclick="focarNoSetor({{ loop.index0 }})">
      <div class="header-area">
        <h4>{{ c.nome_area }}</h4>
        <span class="categoria-tag">{{ c.categoria or 'N/A' }}</span>
      </div>
      <div class="info-area">
        <p><strong>📍 Distância:</strong> {{ '%.2f' % c.distancia_km }} km</p>
        <p><strong>⏱️ Duração:</strong> {{ c.duracao_minutos }} min</p>
        <p><strong>🕒 Data:</strong> {{ c.timestamp.strftime('%d/%m/%Y %H:%M') }}</p>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="sem-conquistas">
    <p>🚫 Nenhuma área registrada.</p>
    <a href="{{ url_for('routes.nova_conquista') }}" class="btn-ver-mapa">📍 Iniciar Missão</a>
  </div>
  {% endif %}

  <div id="map" class="map-container" style="margin-top: 30px;"></div>

  <script>
    let setores = [];
    let map;
    let mapaCarregado = false;

    function focarNoSetor(index) {
      if (!mapaCarregado || setores.length === 0) {
        alert("⏳ O mapa está carregando. Tente novamente em instantes.");
        return;
      }
      const setor = setores[parseInt(index)];
      if (setor) {
        map.fitBounds(setor.getBounds());
        setor.openPopup();
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      map = L.map('map').setView([-5.8161, -35.2889], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      {% for c in conquistas %}
        {% if c.poligono_geojson and 'geometry' in c.poligono_geojson %}
          var dados = {{ c.poligono_geojson['geometry'] | tojson | safe }};
          var tipo = dados.type;
          var coords = dados.coordinates;
          var opcoes = { color: '#16a085', fillOpacity: 0.4, weight: 2 };
          var camada;

          if (tipo === "Polygon") {
            camada = L.polygon(coords[0].map(p => [p[1], p[0]]), opcoes);
          } else if (tipo === "LineString") {
            camada = L.polyline(coords.map(p => [p[1], p[0]]), opcoes);
          }

          if (camada) {
            var popupHtml = `
              <strong>{{ c.nome_area }}</strong><br>
              📏 {{ '%.2f' % c.distancia_km }} km<br>
              ⏱️ {{ c.duracao_minutos }} min<br>
              🕒 {{ c.timestamp.strftime('%d/%m/%Y %H:%M') }}
            `;
            camada.bindPopup(popupHtml);
            camada.addTo(map);
            setores.push(camada);
          }
        {% endif %}
      {% endfor %}

      if (setores.length === 0) {
        const latDefault = -5.9161;
        const lngDefault = -35.2618;
        map.setView([latDefault, lngDefault], 15);
        L.marker([latDefault, lngDefault]).addTo(map)
          .bindPopup(`📍 Ponto de partida:<br>Lat: ${latDefault}<br>Lng: ${lngDefault}`)
          .openPopup();
      }

      map.on('click', function(e) {
        const { lat, lng } = e.latlng;
        if (window.marcadorClique) {
          map.removeLayer(window.marcadorClique);
        }
        window.marcadorClique = L.marker([lat, lng]).addTo(map)
          .bindPopup(`📍 Ponto tático:<br>Lat: ${lat.toFixed(5)}<br>Lng: ${lng.toFixed(5)}`)
          .openPopup();
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            map.setView([lat, lng], 15);
            L.marker([lat, lng]).addTo(map)
              .bindPopup(`📍 Sua posição atual:<br>Lat: ${lat.toFixed(5)}<br>Lng: ${lng.toFixed(5)}`)
              .openPopup();
          },
          function(error) {
            console.warn("⚠️ Erro na geolocalização:", error.message);
          }
        );
      }

      mapaCarregado = true;
    });
  </script>

  <div class="motivacional">
    <p>"Cada passo é território conquistado. Avance!" 🚀</p>
  </div>
</div>
{% endblock %}
